<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>315ç­å•è¯å¤§é—¯å…³ - æ–°æ˜¥è´ºå²ç‰ˆ</title>
    <style>
        /* ==========================================
           1. å…¨å±€åŸºç¡€ä¸é˜²è¯¯è§¦é‡ç½® (æ˜¥èŠ‚å–œåº†ç‰ˆ)
           ========================================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            touch-action: manipulation; 
            user-select: none; 
            -webkit-user-select: none;
            font-family: 'Helvetica Neue', Helvetica, Arial, 'Microsoft YaHei', sans-serif;
        }

        :root {
            --success: #10B981;
            --error: #EF4444;
            --gold-light: #FFEA00;
            --gold-main: #FFD700;
            --gold-dark: #FFB300;
            --red-light: #FF5252;
            --red-main: #D32F2F;
            --red-dark: #8B0000;
            --text-dark: #3E2723; /* æ·±æ£•è‰²ï¼Œé€‚åˆåœ¨æš–ç™½åº•è‰²ä¸Šé˜…è¯» */
        }

        body {
            /* å–œåº†çš„ä¸­å›½çº¢å‘å…‰æ¸å˜èƒŒæ™¯ï¼Œä»¿ä½›æŒ‚æ»¡çº¢ç¯ç¬¼ */
            background: radial-gradient(circle at 50% 20%, var(--red-light) 0%, var(--red-main) 40%, var(--red-dark) 100%);
            color: #ffffff;
            min-height: 100vh;
            width: 100vw;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hidden { display: none !important; }

        .app-container {
            width: 100%;
            max-width: 500px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        /* ==========================================
           2. é¡¶éƒ¨çŠ¶æ€æ ä¸ç§¯åˆ†æ¿ (é‡‘å­—æ‹›ç‰Œ)
           ========================================== */
        .score-board {
            position: fixed;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #D32F2F, #B71C1C);
            color: var(--gold-main);
            padding: 8px 18px;
            border-radius: 25px;
            border: 2px solid var(--gold-main);
            font-weight: 900;
            font-size: 1.25rem;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,215,0,0.3);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .status-bar {
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 12px 18px;
            border-radius: 15px;
            font-size: 0.95rem;
            color: var(--gold-light);
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: bold;
            border: 1px solid rgba(255, 215, 0, 0.4);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* ==========================================
           3. æˆ˜æ–—èˆå° (Arena) - é»‘åº• + é‡‘æ¡†çº¢åœ°æ¯¯
           ========================================== */
        .arena {
            width: 100%;
            height: 140px;
            /* ä¿æŒçº¯é»‘åº•è‰²ï¼Œå®Œç¾éšè—ä½ çš„åˆºå®¢å›¾ç‰‡é»‘è¾¹ */
            background: #000000; 
            border-radius: 16px;
            border: 3px solid var(--gold-main);
            /* ä¸‹è¾¹æ¡†åšæˆç²—ç²—çš„çº¢åœ°æ¯¯æ•ˆæœï¼Œé…ä¸Šå†…é˜´å½± */
            border-bottom: 12px solid var(--red-main);
            position: relative; 
            overflow: hidden; 
            margin-bottom: 15px;
            box-shadow: inset 0 -4px 0 var(--gold-dark), 0 8px 20px rgba(0,0,0,0.6);
        }

        .timer-display {
            position: absolute; 
            top: 8px;
            left: 50%; 
            transform: translateX(-50%);
            color: var(--gold-main); 
            font-weight: 900; 
            font-size: 1.1rem; 
            background: rgba(139, 0, 0, 0.85); 
            padding: 4px 18px; 
            border-radius: 20px; 
            z-index: 5;
            border: 2px solid var(--gold-main);
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        /* è§’è‰²æ”¾å¤§ 1.5 å€ (112px) ä¿æŒä¸å˜ */
        .entity {
            position: absolute;
            bottom: 5px; /* ç¨å¾®ä¸‹æ²‰ä¸€ç‚¹è´´åˆçº¢åœ°æ¯¯ */
            width: 112px; 
            height: auto;
            transition: transform 0.1s;
            z-index: 2;
        }
        
        #harry-emoji { left: 10px; }
        #monster-emoji { right: 10px; }
        .moving-left { right: calc(100% - 120px) !important; }

        /* çˆ†ç«¹çƒŸèŠ±èˆ¬çš„é­”æ³•å…‰æŸ */
        #magic-beam {
            position: absolute;
            bottom: 55px; 
            left: 100px; 
            width: 50px; 
            height: 8px; /* ç¨å¾®åŠ ç²— */
            border-radius: 10px;
            /* é‡‘çº¢äº¤ç»‡çš„ç«èŠ±æ‹–å°¾ */
            background: linear-gradient(to right, transparent, #FF4500, #FFD700, #FFFFFF);
            opacity: 0; 
            z-index: 3;
            filter: drop-shadow(0 0 10px #FF4500) drop-shadow(0 0 5px #FFD700);
        }
        .shooting { left: calc(100% - 120px) !important; opacity: 1 !important; }

        /* ==========================================
           4. å­¦ä¹ å†…å®¹åŒº (çº¢åŒ…è¯·æŸ¬è´¨æ„Ÿå¡ç‰‡)
           ========================================== */
        .card {
            /* æš–ç™½è‰²/æµ…ç±³è‰²ï¼Œä¿æŠ¤è§†åŠ›ä¸”æ¸…æ™° */
            background: #FFF8DC; 
            /* çº¢é‡‘åŒå±‚è¾¹æ¡†æ•ˆæœ */
            border: 5px solid var(--red-main);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4), inset 0 0 0 4px var(--gold-main);
            padding: 30px 20px;
            width: 100%;
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            min-height: 240px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex: 1;
        }

        .word-text { 
            font-size: 3.2rem; 
            font-weight: 900;
            color: var(--red-dark); /* æ·±çº¢è‰²å•è¯ï¼Œéå¸¸é†’ç›® */
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 5px 0; 
            line-height: 1.2; 
        }

        .meaning-text { 
            font-size: 1.3rem; 
            color: var(--text-dark); /* æ·±æ£•è‰²é‡Šä¹‰ï¼ŒæŸ”å’Œæ˜“è¯» */
            margin-bottom: 25px; 
            font-weight: bold;
        }

        /* å½•éŸ³æŒ‰é’®ï¼šç¦æ°”é‡‘çº¢æŒ‰é’® */
        .mic-container { position: relative; margin-top: 10px; }
        .mic-btn {
            width: 90px; height: 90px; border-radius: 50%; 
            background: radial-gradient(circle, var(--gold-main), #FF8F00); 
            color: var(--red-main); 
            border: 4px solid #FFFFFF; 
            font-size: 38px; cursor: pointer; display: flex; 
            justify-content: center; align-items: center;
            box-shadow: 0 8px 20px rgba(211, 47, 47, 0.4); 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 2; outline: none;
        }
        .mic-btn:active { transform: scale(0.9); box-shadow: 0 4px 10px rgba(211, 47, 47, 0.4); }
        .mic-btn.listening { 
            background: radial-gradient(circle, #FFFFFF, var(--gold-main));
            border-color: var(--red-main); 
            animation: pulse-gold 1.5s infinite;
        }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.8); }
            70% { box-shadow: 0 0 0 25px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        /* é€‰é¡¹æŒ‰é’®ï¼šå¤§çº¢åº•è‰² + é‡‘è‰²è¾¹æ¡† */
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 14px; width: 100%; }
        .option-btn {
            background: linear-gradient(to bottom, #E53935, #C62828); 
            border: 2px solid var(--gold-main); 
            padding: 18px; border-radius: 16px; font-size: 1.15rem; font-weight: 900;
            color: #FFFFFF; text-align: center; cursor: pointer; transition: all 0.1s;
            box-shadow: 0 5px 0 #8B0000, 0 8px 10px rgba(0,0,0,0.2); /* ç«‹ä½“æŒ‰é”®æ„Ÿ */
            text-shadow: 0 1px 2px rgba(0,0,0,0.4);
        }
        .option-btn:active { 
            transform: translateY(5px); 
            box-shadow: 0 0 0 #8B0000, 0 0 0 transparent !important;
        }
        .option-btn.correct { background: linear-gradient(to bottom, #34D399, #059669); border-color: #A7F3D0; box-shadow: 0 5px 0 #047857; }
        .option-btn.wrong { background: linear-gradient(to bottom, #9CA3AF, #4B5563); border-color: #D1D5DB; box-shadow: 0 5px 0 #374151; color: #E5E7EB; }

        /* æ‹¼å†™è¾“å…¥æ¡† */
        .spell-input {
            width: 90%; padding: 15px; font-size: 1.6rem; text-align: center;
            background: #FFFFFF; color: var(--red-dark); 
            border: 3px solid var(--red-light); 
            border-radius: 15px; outline: none; margin-bottom: 15px;
            font-weight: bold; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .spell-input:focus { border-color: var(--gold-main); box-shadow: 0 0 10px rgba(255,215,0,0.5); }

        /* ==========================================
           5. é€‰å•ç•Œé¢ (ç¦ç‰Œæ ·å¼)
           ========================================== */
        #view-menu { text-align: center; padding-top: 40px; }
        
        .main-title {
            color: var(--gold-main);
            margin-bottom: 5px; 
            font-size: 2.6rem; 
            font-weight: 900;
            /* é‡‘å­—å‘å…‰é˜´å½± */
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 4px 6px rgba(0,0,0,0.6);
            letter-spacing: 2px;
        }

        .unit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; width: 100%; margin-top: 35px; }
        .unit-item { 
            background: linear-gradient(to bottom, #FFF8DC, #FFE4B5); 
            border: 3px solid var(--red-main); 
            border-radius: 16px; padding: 22px 0; text-align: center; cursor: pointer; 
            font-weight: 900; color: var(--red-dark); transition: all 0.2s; 
            box-shadow: 0 6px 0 var(--red-dark), 0 8px 15px rgba(0,0,0,0.3);
        }
        .unit-item:active { transform: translateY(6px); box-shadow: 0 0 0 transparent; }
        .unit-item.active { 
            border-color: var(--gold-main); 
            background: linear-gradient(to bottom, #FFD700, #FFB300);
            color: #8B0000; 
            box-shadow: 0 6px 0 #D84315, 0 8px 15px rgba(0,0,0,0.3);
        }
        .unit-item.locked { opacity: 0.6; cursor: not-allowed; filter: grayscale(50%); box-shadow: none; transform: translateY(6px); }

        /* ==========================================
           6. ç‰¹æ•ˆä¸åŠ¨ç”» 
           ========================================== */
        .flash-red { animation: flashRed 0.5s; }
        @keyframes flashRed { 
            0% { box-shadow: inset 0 0 50px rgba(255, 0, 0, 0.8); } 
            100% { box-shadow: inset 0 -4px 0 var(--gold-dark), 0 8px 20px rgba(0,0,0,0.6); } 
        }
        
        .anim-shake { animation: shake 0.3s ease-in-out; }
        @keyframes shake { 
            0% { transform: translateX(0); } 25% { transform: translateX(-6px); } 
            50% { transform: translateX(6px); } 75% { transform: translateX(-6px); } 
            100% { transform: translateX(0); } 
        }

        /* æç¤ºæ¡† */
        .feedback-toast {
            position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: white; padding: 10px 22px; border-radius: 15px;
            font-size: 1rem; font-weight: bold; opacity: 0; transition: all 0.3s ease-out; 
            pointer-events: none; z-index: 10; width: max-content; max-width: 90%; text-align: center; line-height: 1.4;
            border: 2px solid var(--gold-main); box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .feedback-toast.show { opacity: 1; top: 15px; }
        .feedback-toast.success { background: linear-gradient(135deg, #059669, #047857); border-color: #34D399; }
        .feedback-toast.error { background: linear-gradient(135deg, #DC2626, #991B1B); border-color: #FCA5A5; }

        .score-popup {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
            color: var(--gold-main); font-weight: 900;
            text-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 5px 5px #8B0000;
            pointer-events: none; z-index: 2000; width: 100%; text-align: center;
            animation: floatUp 2.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }
        
        @keyframes floatUp {
            0% { opacity: 0; transform: translate(-50%, -10%) scale(0.5); }
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -100%) scale(1.2); }
        }

        .save-toast {
            position: fixed; bottom: 20px; right: 20px; 
            background: linear-gradient(135deg, #FFF8DC, #FFE4B5); color: #D32F2F; 
            padding: 10px 20px; border-radius: 30px; font-size: 0.95rem; font-weight: 900; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.4); opacity: 0; transform: translateY(20px); transition: all 0.4s ease;
            pointer-events: none; z-index: 9999; border: 2px solid var(--gold-main);
        }
        .save-toast.show { opacity: 1; transform: translateY(0); }

        .btn-link { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: #FFF; 
            padding: 10px 20px; border-radius: 20px; text-decoration: none; margin-top: 15px; cursor: pointer; 
            font-size: 1.05rem; font-weight: bold; transition: background 0.2s;
        }
        .btn-link:active { background: rgba(255,255,255,0.2); }
        
        .footer-reset { 
            margin-top: 50px; margin-bottom: 20px; font-size: 0.85rem; color: #FFCDD2; 
            text-decoration: underline; cursor: pointer; opacity: 0.7; font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="score-board" class="score-board">ğŸ† Score: <span id="score-value">0</span></div>

    <div class="app-container">
        <div id="view-menu">
            <h1 class="main-title">315ç­å•è¯å¤§é—¯å…³</h1>
            <p style="color:var(--gold-light); font-size: 1.2rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">ğŸ® æ–°æ˜¥è´ºå²ç‰ˆ ğŸ®</p>
        
            <div id="unit-list" class="unit-grid"></div>
            
            <div onclick="resetProgress()" class="footer-reset">
                Reset All Progress (é‡ç½®è¿›åº¦)
            </div> 
        </div>

        <div id="view-game" class="hidden">
            
            <div id="battle-arena" class="arena">
                <div id="arena-timer" class="timer-display">â³ 10s</div>
                <img src="assets/harry.png" id="harry-emoji" class="entity" alt="Harry">
                <img src="assets/spell.png" id="magic-beam" alt="Spell">
                <img src="assets/monster.png" id="monster-emoji" class="entity" alt="Monster">
            </div>

            <div class="status-bar">
                <span id="status-phase">Phase 1</span>
                <span id="status-progress">1/5</span>
                <span id="status-rep" class="hidden">Hit 0/3</span>
            </div>

            <div class="card">
                <div id="feedback" class="feedback-toast">Correct!</div>
                
                <div style="display:flex; align-items:center; justify-content:center; gap:12px;">
                    <div id="area-word" class="word-text">Word</div>
                    <button onclick="speakCurrentWord()" style="background:#FFF3E0; border:3px solid #FFB300; border-radius:50%; width: 45px; height: 45px; font-size:1.5rem; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 0 #FFB300; transition: transform 0.1s;">ğŸ”Š</button>
                </div>
                <div id="area-meaning" class="meaning-text">Meaning</div>

                <div id="area-mic" class="mic-container hidden">
                    <button id="btn-mic" class="mic-btn">ğŸ™ï¸</button>
                    <p id="mic-hint" style="font-size: 0.95rem; color:#8B0000; margin-top:15px; font-weight: bold;">ç‚¹å‡»æ–½æ”¾é­”æ³•</p>
                </div>

                <div id="area-options" class="options-grid hidden"></div>

                <div id="area-spell" class="hidden" style="width:100%">
                    <input type="text" id="input-spell" class="spell-input" placeholder="è¾“å…¥å’’è¯­ (æ‹¼å†™)" autocomplete="off">
                    <button class="option-btn" style="width: 100%; margin-top: 5px;" onclick="checkSpelling()">âš¡ å‘å°„é­”å’’</button>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn-link" onclick="exitToMenu()">é€€å‡ºæˆ˜åœº</button>
            </div>
        </div>
    </div>

    <script src="word_data.js"></script>

    <script>
        const Game = {
            unit: 1, groupIndex: 0, wordIndex: 0, phase: 1,
            score: 0, timerId: null, timeLeft: 10,  
            currentWords: [], repCount: 0, 
            failCount: 0, 
            recognition: null, isListening: false, allGroups: [],
            sfxShoot: new Audio('assets/shoot.mp3'),
            sfxFail: new Audio('assets/fail.mp3')
        };

        function autoSave() {
            localStorage.setItem('progress_unit_' + Game.unit, Game.groupIndex);
            localStorage.setItem('currentScore', Game.score);
            const toast = document.getElementById('save-toast');
            if(toast) {
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            }
        }

        function addScore(points, customText) {
            Game.score += points;
            document.getElementById('score-value').innerText = Game.score; // ä¿®å¤ï¼šç”¨ score-value
            localStorage.setItem('totalScore', Game.score); 
            
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            
            if (customText) {
                popup.innerHTML = customText;
                popup.style.fontSize = '2.5rem';
                popup.style.lineHeight = '1.4';
            } else {
                popup.innerText = `ğŸ‰ +${points} åˆ†!`;
                popup.style.fontSize = '3.5rem';
            }
            
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 2500); 
            autoSave();
        }

        function checkAutoLoad() {
            const savedUnit = localStorage.getItem('currentUnit');
            const savedGroup = localStorage.getItem('currentGroup');
            const savedScore = localStorage.getItem('currentScore');
            if (savedScore) {
                Game.score = parseInt(savedScore);
                document.getElementById('score-value').innerText = Game.score;
            }

            if (savedUnit && savedGroup) {
                const u = parseInt(savedUnit);
                const g = parseInt(savedGroup);
                if(confirm(`æ£€æµ‹åˆ°ä¸Šæ¬¡å­¦ä¹ è¿›åº¦ï¼šUnit ${u} - Group ${g + 1}\nå½“å‰ç§¯åˆ†ï¼š${Game.score}\næ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                    startGame(u, g);
                } else {
                    renderMenu();
                }
            } else {
                renderMenu();
            }
        }

        function resetProgress() {
            if (confirm("âš ï¸ è­¦å‘Šï¼š\nç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­¦ä¹ è¿›åº¦å—ï¼Ÿ\nè¿™å°†æ— æ³•æ¢å¤ï¼")) {
                localStorage.clear();
                location.reload();
            }
        } 

        const UI = {
            menu: document.getElementById('view-menu'),
            game: document.getElementById('view-game'),
            unitList: document.getElementById('unit-list'),
            statusPhase: document.getElementById('status-phase'),
            statusProg: document.getElementById('status-progress'),
            statusRep: document.getElementById('status-rep'),
            areaWord: document.getElementById('area-word'),
            areaMeaning: document.getElementById('area-meaning'),
            areaMic: document.getElementById('area-mic'),
            areaOpts: document.getElementById('area-options'),
            areaSpell: document.getElementById('area-spell'),
            btnMic: document.getElementById('btn-mic'),
            micHint: document.getElementById('mic-hint'),
            inputSpell: document.getElementById('input-spell'),
            feedback: document.getElementById('feedback'),
            harry: document.getElementById('harry-emoji'),
            monster: document.getElementById('monster-emoji'),
            spell: document.getElementById('magic-beam')
        };

        function startCombatTimer() {
            clearInterval(Game.timerId);
            Game.timeLeft = 20; 
            document.getElementById('arena-timer').innerText = `â³ 10s`;
            
            const monster = UI.monster;
            monster.style.transition = 'none';
            monster.style.right = '15px';
            void monster.offsetWidth; 
            
            monster.style.transition = 'right 20s linear';
            monster.classList.add('moving-left');

            Game.timerId = setInterval(() => {
                Game.timeLeft--;
                document.getElementById('arena-timer').innerText = `â³ ${Game.timeLeft}s`;
                if(Game.timeLeft <= 0) handleTimeout(); 
            }, 1000);
        }

        function stopCombatTimer() {
            clearInterval(Game.timerId);
            const monster = UI.monster;
            const currentRight = window.getComputedStyle(monster).right;
            monster.style.transition = 'none';
            monster.style.right = currentRight;
            monster.classList.remove('moving-left');
        }

        function handleTimeout() {
            stopCombatTimer();
            Game.failCount++; 
            
            if (Game.failCount >= 6) {
                playAttack(() => {
                    showToast("æ²¡å…³ç³»ï¼Œè¿™ä¸ªè¯å¤ªç‹¡çŒ¾å•¦ï¼Œæˆ‘ä»¬å…ˆå­¦ä¸‹ä¸€ä¸ªï¼", true);
                    Game.repCount = 0;
                    Game.failCount = 0;
                    nextWord();
                });
                return;
            }

            playFail(); 
            
            const arena = document.getElementById('battle-arena');
            arena.classList.add('flash-red');
            setTimeout(() => arena.classList.remove('flash-red'), 500);
            
            startCombatTimer();
        }

        window.onload = function() {
            if(typeof wordList === 'undefined') return alert("æœªæ‰¾åˆ° word_data.js");
            initSpeech();
            
            Game.score = parseInt(localStorage.getItem('totalScore')) || 0;
            const scoreValue = document.getElementById('score-value');
            if(scoreValue) {
                scoreValue.innerText = Game.score;
            }
            
            renderMenu();
        };

        function playAttack(callback) {
            stopCombatTimer();
            
            if(Game.sfxShoot) { Game.sfxShoot.currentTime = 0; Game.sfxShoot.play().catch(e=>{}); }
            
            const beam = UI.spell;
            beam.style.transition = 'none';
            beam.style.left = '100px';
            beam.style.opacity = '1';
            void beam.offsetWidth;
            beam.style.transition = 'left 0.2s linear, opacity 0.2s';
            beam.classList.add('shooting');
            setTimeout(() => {
                beam.classList.remove('shooting');
                beam.style.opacity = '0';
                
                UI.monster.style.transition = 'none';
                UI.monster.style.right = '15px';
                
                if (callback) callback();
            }, 200);
        }

        function playFail() {
            Game.sfxFail.currentTime = 0;
            Game.sfxFail.play().catch(e => console.log("Audio play error", e));
            UI.harry.classList.remove('anim-shake');
            void UI.harry.offsetWidth;
            UI.harry.classList.add('anim-shake');
        }

        function initSpeech() {
            const onlineAudio = new Audio();
            window.speak = function(text) {
                const isWeChat = /MicroMessenger/i.test(navigator.userAgent);
                if (isWeChat || text.split(' ').length <= 3) {
                    onlineAudio.pause();
                    onlineAudio.currentTime = 0;
                    onlineAudio.src = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`;
                    onlineAudio.play().catch(e => {
                        systemSpeak(text);
                    });
                } else {
                    systemSpeak(text);
                }
            };

            function systemSpeak(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-US';
                    u.rate = 1.0;
                    const voices = window.speechSynthesis.getVoices();
                    const enVoice = voices.find(v => v.lang.includes('en-US'));
                    if (enVoice) u.voice = enVoice;
                    window.speechSynthesis.speak(u);
                }
            }
    
            if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                Game.recognition = new SpeechRecognition();
                Game.recognition.lang = 'en-US'; 
                Game.recognition.continuous = false; 
                Game.recognition.interimResults = false;
                Game.recognition.onstart = () => {
                    Game.isListening = true;
                    UI.btnMic.classList.add('listening'); 
                    UI.micHint.textContent = "æ­£åœ¨æ–½æ³•...";
                };
                Game.recognition.onend = () => {
                    Game.isListening = false;
                    UI.btnMic.classList.remove('listening'); 
                    UI.micHint.textContent = "ç‚¹å‡»æ–½æ”¾é­”æ³•";
                };
                Game.recognition.onresult = (e) => {
                    verifySpeech(e.results[0][0].transcript);
                };
                UI.btnMic.onclick = function() {
                    if(Game.isListening) Game.recognition.stop();
                    else Game.recognition.start();
                };
            } else {
                console.log("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«");
            }
        }

        function renderMenu() {
            UI.menu.classList.remove('hidden');
            UI.game.classList.add('hidden'); UI.unitList.innerHTML = '';
            const unlocked = parseInt(localStorage.getItem('unlockedUnit') || 1);
            [...new Set(wordList.map(w => w.unit))].sort((a,b)=>a-b).forEach(u => {
                const div = document.createElement('div');
                const isLocked = u > unlocked;
                div.className = `unit-item ${isLocked ? 'locked' : 'active'}`;
                div.textContent = `Unit ${u}`;
                if(!isLocked) div.onclick = () => {
                    if('speechSynthesis' in window) { 
                        window.speechSynthesis.cancel(); 
                        const w = new SpeechSynthesisUtterance(''); 
                        w.volume = 0; 
                        window.speechSynthesis.speak(w); 
                    }
                    const savedProgress = localStorage.getItem('progress_unit_' + u);
                    if (savedProgress === 'COMPLETED') {
                        if (confirm(`Unit ${u} å·²ç»é€šå…³å•¦ï¼ğŸ‰\næ˜¯å¦éœ€è¦æ¸…é™¤è¿›åº¦ï¼Œé‡æ–°å¤ä¹ ä¸€éï¼Ÿ`)) {
                            localStorage.removeItem('progress_unit_' + u);
                            startGame(u, 0); 
                        }
                    } else if (savedProgress !== null) {
                        const groupIndex = parseInt(savedProgress);
                        startGame(u, groupIndex); 
                    } else {
                        startGame(u, 0);
                    }
                };
                UI.unitList.appendChild(div);
            });
        }

        function startGame(unitId, startGroupIndex = 0) {
            Game.unit = unitId;
            const raw = wordList.filter(w => w.unit === unitId);
            Game.allGroups = [];
            for(let i=0; i<raw.length; i+=5) Game.allGroups.push(raw.slice(i, i+5));
            UI.menu.classList.add('hidden'); 
            UI.game.classList.remove('hidden');
            loadGroup(startGroupIndex);
        }

        function loadGroup(idx) {
            if(idx >= Game.allGroups.length) { 
                startUnitReview();
                return; 
            }
            Game.groupIndex = idx;
            Game.currentWords = Game.allGroups[idx];
            autoSave(); 
            startPhase(1);
        }

        function startPhase(p) {
            Game.phase = p; Game.wordIndex = 0;
            Game.repCount = 0; 
            Game.failCount = 0; 
            
            const pNames = ["Shadowing (è·Ÿè¯»)", "Listening (å¬éŸ³)", "Speaking (è¯´è‹±)", "Spelling (æ‹¼å†™)", "Review"];
            UI.statusPhase.textContent = pNames[p-1] || "Review";
            renderCard();
        }

        function renderCard() {
            const wordObj = Game.currentWords[Game.wordIndex];
            const total = Game.currentWords.length;
            UI.statusProg.textContent = `Word ${Game.wordIndex+1}/${total}`;
            
            UI.areaMic.classList.add('hidden'); UI.areaOpts.classList.add('hidden'); UI.areaSpell.classList.add('hidden');
            UI.areaWord.classList.remove('hidden'); UI.areaMeaning.classList.remove('hidden'); UI.statusRep.classList.add('hidden');

            if(Game.phase === 1) {
                UI.statusRep.classList.remove('hidden');
                UI.statusRep.textContent = `Hit ${Game.repCount}/3`;
                UI.areaWord.textContent = wordObj.word;
                UI.areaMeaning.textContent = wordObj.meaning;
                UI.areaMic.classList.remove('hidden');
                if(Game.repCount === 0) speak(wordObj.word);
            }
            else if(Game.phase === 2) {
                UI.areaWord.classList.add('hidden');
                UI.areaMeaning.classList.add('hidden');
                UI.areaOpts.classList.remove('hidden');
                speak(wordObj.word);
                generateOptions(wordObj);
            }
            else if(Game.phase === 3 || Game.phase === 5) {
                UI.areaWord.classList.add('hidden');
                UI.areaMeaning.textContent = wordObj.meaning;
                UI.areaMic.classList.remove('hidden');
            }
            else if(Game.phase === 4) {
                UI.areaWord.classList.add('hidden');
                UI.areaMeaning.textContent = wordObj.meaning;
                UI.areaSpell.classList.remove('hidden');
                UI.inputSpell.value = ''; UI.inputSpell.focus();
            }
            startCombatTimer();
        }

        function verifySpeech(transcript) {
            if (!Game.currentWords || !Game.currentWords[Game.wordIndex]) return;
            const target = Game.currentWords[Game.wordIndex].word;
            const cleanTrans = transcript.toLowerCase().replace(/[^a-z0-9]/g, '');
            const cleanTarget = target.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            if(cleanTrans.includes(cleanTarget) || cleanTarget.includes(cleanTrans)) {
                handleSuccess();
            } else {
                handleFail();
            }
        }

        function handleSuccess() {
            Game.failCount = 0; 
            
            playAttack(() => {
                showToast("Magic Hit!", true);
                
                if(Game.phase === 1) {
                    Game.repCount++; 
                    UI.statusRep.textContent = `Hit ${Game.repCount}/3`;
                    
                    if(Game.repCount < 3) {
                        startCombatTimer(); 
                        speak(Game.currentWords[Game.wordIndex].word);
                    } else 
                    { 
                        Game.repCount = 0; 
                        nextWord(); 
                    }
                } else {
                    nextWord();
                }
            });
        }

        function handleFail() {
            Game.failCount++; 
            
            if (Game.failCount >= 6) {
                playAttack(() => {
                    showToast("æ²¡å…³ç³»ï¼Œè¿™ä¸ªè¯å¤ªç‹¡çŒ¾å•¦ï¼Œæˆ‘ä»¬å…ˆå­¦ä¸‹ä¸€ä¸ªï¼", true);
                    
                    Game.repCount = 0; 
                    Game.failCount = 0;
                    nextWord(); 
                });
                return; 
            }

            playFail();
            showToast("Miss!", false);
        }

        function nextWord() {
            Game.failCount = 0; 
            Game.wordIndex++;
            
            if(Game.wordIndex >= Game.currentWords.length) {
                if(Game.phase < 4) startPhase(Game.phase + 1);
                else if (Game.phase === 4) { 
                    
                    addScore(10, "ğŸ‰ æ­å–œå®Œæˆï¼<br><span style='color:#FFD700;'>+10 åˆ†</span>");
                    setTimeout(() => loadGroup(Game.groupIndex + 1), 2500);
                }
                else finishUnit();
            } else renderCard();
        }

        function generateOptions(correctObj) {
            UI.areaOpts.innerHTML = '';
            const others = wordList.filter(w => w.word !== correctObj.word);
            const distractors = others.sort(() => 0.5 - Math.random()).slice(0, 3);
            const opts = [...distractors, correctObj].sort(() => 0.5 - Math.random());

            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt.meaning;
                btn.onclick = () => {
                    if(opt.word === correctObj.word) handleSuccess();
                    else { handleFail(); speak(correctObj.word); }
                };
                UI.areaOpts.appendChild(btn);
            });
            const replay = document.createElement('button');
            replay.className = 'option-btn'; replay.style.textAlign='center'; replay.textContent='ğŸ”Š é‡å¬';
            replay.onclick = () => speak(correctObj.word);
            UI.areaOpts.appendChild(replay);
        }

        function checkSpelling() {
            const input = UI.inputSpell.value.trim().toLowerCase();
            const target = Game.currentWords[Game.wordIndex].word.toLowerCase();
            if(input === target) {
                UI.inputSpell.classList.add('correct');
                handleSuccess();
                setTimeout(() => UI.inputSpell.classList.remove('correct'), 500);
            } else {
                UI.inputSpell.classList.add('wrong');
                handleFail();
            }
        }

        function startUnitReview() {
            Game.phase = 5;
            UI.statusPhase.textContent = "Boss Battle (Review)";
            Game.currentWords = wordList.filter(w => w.unit === Game.unit).sort(() => 0.5 - Math.random());
            Game.wordIndex = 0; renderCard();
        }

        function finishUnit() {
            showToast("Unit Victory!", true);
            const currentUnlocked = parseInt(localStorage.getItem('unlockedUnit') || 1);
            
            if(Game.unit >= currentUnlocked) {
                localStorage.setItem('unlockedUnit', Game.unit + 1);
            }
            
            localStorage.setItem('progress_unit_' + Game.unit, 'COMPLETED');
            setTimeout(() => { UI.game.classList.add('hidden'); renderMenu(); }, 2000);
        }

        function showToast(msg, isSuccess) {
            UI.feedback.textContent = msg;
            UI.feedback.className = `feedback-toast show ${isSuccess ? 'success' : 'error'}`;
            setTimeout(() => UI.feedback.className = 'feedback-toast', 1000);
        }
        function exitToMenu() { UI.game.classList.add('hidden'); renderMenu(); }
        UI.inputSpell.addEventListener('keyup', (e) => { if(e.key === 'Enter') checkSpelling(); });
        function speakCurrentWord() {
            if (Game.currentWords && Game.currentWords[Game.wordIndex]) {
                speak(Game.currentWords[Game.wordIndex].word);
            }
        }
    </script>
    <div id="save-toast" class="save-toast">ğŸ’¾ è¿›åº¦å·²ä¿å­˜</div>
</body>
</html>