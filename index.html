<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harry Potter: Magic Word Battle</title>
    <style>
        /* ==========================================
           1. å…¨å±€åŸºç¡€ä¸é˜²è¯¯è§¦é‡ç½®
           ========================================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            touch-action: manipulation; 
            user-select: none; 
            -webkit-user-select: none;
        }

        :root {
            --primary: #4F46E5;
            --success: #10B981;
            --error: #EF4444;
            --text: #ffffff;
        }

        body {
            /* é­”æ³•æ·±æ¸Šæ¸å˜èƒŒæ™¯ */
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            width: 100vw;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hidden { display: none !important; }

        .app-container {
            width: 100%;
            max-width: 500px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        /* ==========================================
           2. é¡¶éƒ¨çŠ¶æ€æ ä¸ç§¯åˆ†æ¿
           ========================================== */
        .score-board {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: #FFD700;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.5);
            font-weight: bold;
            font-size: 1.2rem;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .status-bar {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 0.9rem;
            color: #a8dadc;
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: bold;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* ==========================================
           3. æˆ˜æ–—èˆå° (Arena) é€‚é…ä½ çš„å›¾ç‰‡
           ========================================== */
        .arena {
            width: 100%;
            height: 140px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            position: relative; 
            overflow: hidden; 
            margin-bottom: 15px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        .timer-display {
            position: absolute; 
            top: 8px;
            left: 50%; 
            transform: translateX(-50%);
            color: #FFD700; 
            font-weight: bold; 
            font-size: 1.1rem; 
            background: rgba(0,0,0,0.6); 
            padding: 4px 15px; 
            border-radius: 15px; 
            z-index: 5;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .entity {
            position: absolute;
            bottom: 10px; 
            width: 75px; /* è°ƒæ•´äº†å›¾ç‰‡å¤§å°é€‚é…æ‰‹æœº */
            height: auto;
            transition: transform 0.1s;
        }
        
        #harry-emoji { left: 15px; z-index: 2; }
        #monster-emoji { right: 15px; z-index: 2; }
        
        /* é…åˆä½  JS çš„åŠ¨ç”»ç±» */
        .moving-left { right: calc(100% - 90px) !important; }

        #magic-beam {
            position: absolute;
            bottom: 45px; 
            left: 80px; 
            width: 40px; 
            height: auto;
            opacity: 0; 
            z-index: 3;
            filter: drop-shadow(0 0 8px #00f2fe);
        }
        .shooting { left: calc(100% - 90px) !important; opacity: 1 !important; }

        /* ==========================================
           4. å­¦ä¹ å†…å®¹åŒº (ç»ç’ƒæ€å¡ç‰‡)
           ========================================== */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            padding: 25px 20px;
            width: 100%;
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            min-height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex: 1;
        }

        .word-text { 
            font-size: 2.8rem; 
            font-weight: 900;
            color: #ffffff; 
            text-shadow: 0 0 10px rgba(255,255,255,0.4);
            margin: 5px 0; 
            line-height: 1.2; 
        }

        .meaning-text { 
            font-size: 1.2rem;
            color: #b0c4de; 
            margin-bottom: 20px; 
        }

        /* å·¨å‹å½•éŸ³æŒ‰é’® */
        .mic-container { position: relative; margin-top: 10px; }
        .mic-btn {
            width: 85px;
            height: 85px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #00c6ff, #0072ff); 
            color: white;
            border: 3px solid rgba(255,255,255,0.2); 
            font-size: 32px; 
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            box-shadow: 0 8px 20px rgba(0, 114, 255, 0.4); 
            transition: all 0.2s; 
            z-index: 2; 
            outline: none;
        }
        .mic-btn:active { transform: scale(0.9); }
        .mic-btn.listening { 
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            border-color: #ff4b2b;
            box-shadow: 0 0 20px rgba(255, 75, 43, 0.6);
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 75, 43, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 75, 43, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 75, 43, 0); }
        }

        /* é€‰é¡¹æŒ‰é’® */
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; width: 100%; }
        .option-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2); 
            padding: 16px; 
            border-radius: 15px;
            font-size: 1.1rem; 
            font-weight: bold;
            color: white;
            text-align: center; 
            cursor: pointer; 
            transition: all 0.15s;
        }
        .option-btn:active { transform: scale(0.95); background: rgba(255, 215, 0, 0.2); }
        .option-btn.correct { background: rgba(16, 185, 129, 0.3); border-color: var(--success); }
        .option-btn.wrong { background: rgba(239, 68, 68, 0.3); border-color: var(--error); }

        /* æ‹¼å†™è¾“å…¥æ¡† */
        .spell-input {
            width: 90%;
            padding: 15px; 
            font-size: 1.5rem; 
            text-align: center;
            background: rgba(0,0,0,0.3);
            color: white;
            border: 2px solid rgba(255,255,255,0.2); 
            border-radius: 12px; 
            outline: none; 
            margin-bottom: 15px;
        }
        .spell-input:focus { border-color: #00f2fe; }

        /* ==========================================
           5. é€‰å•ç•Œé¢ (Menu View)
           ========================================== */
        #view-menu {
            text-align: center;
            padding-top: 40px;
        }
        .unit-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
            gap: 12px; 
            width: 100%;
            margin-top: 30px; 
        }
        .unit-item { 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-radius: 12px;
            padding: 20px 0; 
            text-align: center; 
            cursor: pointer; 
            font-weight: bold;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
        }
        .unit-item:active { transform: scale(0.95); }
        .unit-item.active { 
            border-color: #00f2fe;
            background: rgba(0, 242, 254, 0.1);
            color: #00f2fe; 
            box-shadow: 0 0 10px rgba(0, 242, 254, 0.3);
        }
        .unit-item.locked { opacity: 0.5; cursor: not-allowed; }

        /* ==========================================
           6. ç‰¹æ•ˆä¸åŠ¨ç”» (å®Œç¾å…¼å®¹ä½ çš„ JS)
           ========================================== */
        .flash-red { animation: flashRed 0.5s; }
        @keyframes flashRed { 
            0% { background-color: rgba(239, 68, 68, 0.4); } 
            100% { background-color: rgba(0, 0, 0, 0.2); } 
        }
        
        .anim-shake { animation: shake 0.3s ease-in-out; }
        @keyframes shake { 
            0% { transform: translateX(0); } 
            25% { transform: translateX(-5px); } 
            50% { transform: translateX(5px); } 
            75% { transform: translateX(-5px); } 
            100% { transform: translateX(0); } 
        }

        .feedback-toast {
            position: absolute;
            top: -50px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 6px 15px; border-radius: 12px;
            font-size: 1rem; font-weight: bold; opacity: 0;
            transition: all 0.3s ease-out; pointer-events: none; z-index: 10;
        }
        .feedback-toast.show { opacity: 1; top: 15px; }
        .feedback-toast.success { background: rgba(16, 185, 129, 0.9); box-shadow: 0 0 15px rgba(16, 185, 129, 0.5); }
        .feedback-toast.error { background: rgba(239, 68, 68, 0.9); box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }

        .score-popup {
            position: fixed;
            top: 40%; left: 50%; transform: translate(-50%, -50%);
            color: #FFD700; font-size: 3.5rem; font-weight: 900;
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
            pointer-events: none; z-index: 2000;
            animation: floatUp 1.2s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }
        @keyframes floatUp {
            0% { opacity: 0; transform: translate(-50%, -30%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -150%) scale(1); }
        }

        .save-toast {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            color: #4ade80; padding: 10px 20px; border-radius: 30px;
            font-size: 0.9rem; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            opacity: 0; transform: translateY(20px); transition: all 0.4s ease;
            pointer-events: none; z-index: 9999; border: 1px solid rgba(74, 222, 128, 0.3);
        }
        .save-toast.show { opacity: 1; transform: translateY(0); }

        .btn-link { 
            background: none; border: none; color: #a8dadc; 
            text-decoration: underline; margin-top: 15px; cursor: pointer; font-size: 1rem;
        }
        
        .footer-reset {
            margin-top: 50px; margin-bottom: 20px; font-size: 0.8rem;
            color: #6B7280; text-decoration: underline; cursor: pointer; opacity: 0.5;
        }
    </style>
</head>
<body>
    <div id="score-board" class="score-board">ğŸ† Score: 0</div>

    <div class="app-container">
        <div id="view-menu">
            <h1 style="color:#fff; margin-bottom: 10px; font-size: 2.2rem; text-shadow: 0 0 15px rgba(0,242,254,0.5);">Hogwarts Words</h1>
            <p style="color:#a8dadc; font-size: 1rem;">Magic Battle Edition</p>
        
            <div id="unit-list" class="unit-grid"></div>
            
            <div onclick="resetProgress()" class="footer-reset">
                Reset All Progress
            </div> 
        </div>

        <div id="view-game" class="hidden">
            
            <div id="battle-arena" class="arena">
                <div id="arena-timer" class="timer-display">â³ 10s</div>
                
                <img src="assets/harry.png" id="harry-emoji" class="entity" alt="Harry">
                <img src="assets/spell.png" id="magic-beam" alt="Spell">
                <img src="assets/monster.png" id="monster-emoji" class="entity" alt="Monster">
            </div>

            <div class="status-bar">
                <span id="status-phase">Phase 1</span>
                <span id="status-progress">1/5</span>
                <span id="status-rep" class="hidden">Hit 0/3</span>
            </div>

            <div class="card">
                <div id="feedback" class="feedback-toast">Correct!</div>
                
                <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                    <div id="area-word" class="word-text">Word</div>
                    <button onclick="speakCurrentWord()" style="background:none; border:none; font-size:1.8rem; cursor:pointer; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));">ğŸ”Š</button>
                </div>
                <div id="area-meaning" class="meaning-text">Meaning</div>

                <div id="area-mic" class="mic-container hidden">
                    <button id="btn-mic" class="mic-btn">ğŸ™ï¸</button>
                    <p id="mic-hint" style="font-size: 0.85rem; color:#a8dadc; margin-top:15px;">ç‚¹å‡»æ–½æ”¾é­”æ³•</p>
                </div>

                <div id="area-options" class="options-grid hidden"></div>

                <div id="area-spell" class="hidden" style="width:100%">
                    <input type="text" id="input-spell" class="spell-input" placeholder="è¾“å…¥å’’è¯­ (æ‹¼å†™)" autocomplete="off">
                    <button class="option-btn" style="background: rgba(0, 242, 254, 0.2); border-color: #00f2fe; color: white;" onclick="checkSpelling()">âš¡ å‘å°„é­”å’’</button>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn-link" onclick="exitToMenu()">é€€å‡ºæˆ˜åœº</button>
            </div>
        </div>
    </div>

    <script src="word_data.js"></script>

    <script>
        /**
         * å…¨å±€çŠ¶æ€ç®¡ç†
         */
        const Game = {
            unit: 1, groupIndex: 0, wordIndex: 0, phase: 1,
            score: 0, 
            timerId: null, timeLeft: 10,  
            currentWords: [], repCount: 0,
            recognition: null, isListening: false, allGroups: [],
            
            // éŸ³æ•ˆå¯¹è±¡
            sfxShoot: new Audio('assets/shoot.mp3'),
            sfxFail: new Audio('assets/fail.mp3')
        };
        // --- æ–°å¢åŠŸèƒ½ï¼šè‡ªåŠ¨å­˜æ¡£ç³»ç»Ÿ ---

        // 1. è‡ªåŠ¨ä¿å­˜å‡½æ•°
        function autoSave() {
            // --- ä¿®æ”¹ï¼šä¸ºæ¯ä¸ª Unit å•ç‹¬ä¿å­˜å½“å‰çš„ Group åºå· ---
            localStorage.setItem('progress_unit_' + Game.unit, Game.groupIndex);
            
            // (ç§¯åˆ†ä¿å­˜ä¿æŒä¸å˜)
            localStorage.setItem('currentScore', Game.score);
            
            const toast = document.getElementById('save-toast');
            if(toast) {
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            }
        }
        // --- æ–°å¢ï¼šåŠ åˆ†ä¸ç‰¹æ•ˆå‡½æ•° ---
        function addScore(points) {
            // 1. å†…å­˜ä¸­åŠ åˆ†
            Game.score += points;
            // 2. æ›´æ–°å³ä¸Šè§’ UI
            document.getElementById('score-board').innerText = `ğŸ† Score: ${Game.score}`;
            // === æ–°å¢ï¼šç«‹å³å°†æ–°åˆ†æ•°å­˜å…¥æœ¬åœ°ç¡¬ç›˜ ===
            localStorage.setItem('totalScore', Game.score);
            // ====================================
            
            // 3. æ’­æ”¾åŠ åˆ†åŠ¨ç”»
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.innerText = `ğŸ‰ +${points} åˆ†!`;
            document.body.appendChild(popup);
            
            // 4. åŠ¨ç”»ç»“æŸåæ¸…ç†æ‰è¿™ä¸ªå…ƒç´ 
            setTimeout(() => popup.remove(), 1500);
            // (è§¦å‘ç»„è¿›åº¦ä¿å­˜)
            autoSave();
        }
            
                
        // 2. æ£€æŸ¥æ˜¯å¦æœ‰å­˜æ¡£ (è‡ªåŠ¨è¯»å–)
        function checkAutoLoad() {
            const savedUnit = localStorage.getItem('currentUnit');
            const savedGroup = localStorage.getItem('currentGroup');
        
            // --- æ–°å¢ï¼šè¯»å–åˆ†æ•° ---
            const savedScore = localStorage.getItem('currentScore');
            if (savedScore) {
                Game.score = parseInt(savedScore);
                document.getElementById('score-board').innerText = `ğŸ† Score: ${Game.score}`;
            }
            // -------------------

            if (savedUnit && savedGroup) {
                const u = parseInt(savedUnit);
                const g = parseInt(savedGroup);
                if(confirm(`æ£€æµ‹åˆ°ä¸Šæ¬¡å­¦ä¹ è¿›åº¦ï¼šUnit ${u} - Group ${g + 1}\nå½“å‰ç§¯åˆ†ï¼š${Game.score}\næ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                    startGame(u, g);
                } else {
                    renderMenu();
                }
            } else {
                renderMenu();
            }
        }

        // 3. é‡ç½®è¿›åº¦å‡½æ•°
        function resetProgress() {
            if (confirm("âš ï¸ è­¦å‘Šï¼š\nç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­¦ä¹ è¿›åº¦å—ï¼Ÿ\nè¿™å°†æ— æ³•æ¢å¤ï¼")) {
                localStorage.clear();
                // æ¸…ç©ºæ‰€æœ‰è®°å½•
                location.reload();
                // åˆ·æ–°é¡µé¢
            }
        } 
        



        /** DOM å…ƒç´ ç¼“å­˜ */
        const UI = {
            menu: document.getElementById('view-menu'),
            game: document.getElementById('view-game'),
            unitList: document.getElementById('unit-list'),
            statusPhase: document.getElementById('status-phase'),
            statusProg: document.getElementById('status-progress'),
            statusRep: document.getElementById('status-rep'),
            areaWord: document.getElementById('area-word'),
        
            areaMeaning: document.getElementById('area-meaning'),
            areaMic: document.getElementById('area-mic'),
            areaOpts: document.getElementById('area-options'),
            areaSpell: document.getElementById('area-spell'),
            btnMic: document.getElementById('btn-mic'),
            micHint: document.getElementById('mic-hint'),
            inputSpell: document.getElementById('input-spell'),
            feedback: document.getElementById('feedback'),
            
            // æ¸¸æˆå…ƒç´ 
            harry: document.getElementById('harry-emoji'),
        
            monster: document.getElementById('monster-emoji'),
            spell: document.getElementById('magic-beam')
        };
        // --- æ–°å¢ï¼š10ç§’å€’è®¡æ—¶ä¸æ€ªå…½ç§»åŠ¨ç³»ç»Ÿ ---
        function startCombatTimer() {
            clearInterval(Game.timerId);
            Game.timeLeft = 20;
            document.getElementById('arena-timer').innerText = `â³ 10s`;
            
            const monster = UI.monster;
            // ç”¨åˆšç»‘å®šçš„æ–°æ€ªå…½
            // ç¬é—´æ‹‰å›æœ€å³è¾¹ï¼Œå–æ¶ˆåŠ¨ç”»
            monster.style.transition = 'none';
            monster.style.right = '15px';
            void monster.offsetWidth; // å¼ºåˆ¶é‡ç»˜
            
            // å¼€å¯ 10ç§’åŒ€é€Ÿå‘å·¦ç§»åŠ¨
            monster.style.transition = 'right 20s linear';
            monster.classList.add('moving-left');

            // å¯åŠ¨å€’è®¡æ—¶
            Game.timerId = setInterval(() => {
                Game.timeLeft--;
                document.getElementById('arena-timer').innerText = `â³ ${Game.timeLeft}s`;
                if(Game.timeLeft <= 0) handleTimeout(); // è¶…æ—¶å¤„ç†
            }, 1000);
        }

        function stopCombatTimer() {
            clearInterval(Game.timerId);
            const monster = UI.monster;
            // å†»ç»“æ€ªå…½å½“å‰ä½ç½®
            const currentRight = window.getComputedStyle(monster).right;
            monster.style.transition = 'none';
            monster.style.right = currentRight;
            monster.classList.remove('moving-left');
        }

        function handleTimeout() {
            stopCombatTimer();
            // æ‰£ 1 åˆ†
            Game.score = Math.max(0, Game.score - 1);
            document.getElementById('score-board').innerText = `ğŸ† Score: ${Game.score}`;
            localStorage.setItem('totalScore', Game.score);

            playFail(); // æ’­æ”¾å¤±è´¥æ‘‡æ™ƒ
            
            // å±å¹•é—ªçº¢è­¦å‘Š
            const arena = document.getElementById('battle-arena');
            arena.classList.add('flash-red');
            setTimeout(() => arena.classList.remove('flash-red'), 500);
            
            // é‡æ–°å¼€å¯è¿™é“é¢˜çš„ 10 ç§’å€’è®¡æ—¶
            startCombatTimer();
        }

        /** åˆå§‹åŒ– */
        window.onload = function() {
            if(typeof wordList === 'undefined') return alert("æœªæ‰¾åˆ° word_data.js");
            initSpeech();
            
            // === æ–°å¢ï¼šåˆå§‹åŒ–è¯»å–æ€»ç§¯åˆ† ===
            // å°è¯•ä»æœ¬åœ°è¯»å– totalScoreï¼Œå¦‚æœæ²¡æœ‰è®°å½•ï¼ˆç¬¬ä¸€æ¬¡ç©ï¼‰ï¼Œå°±é»˜è®¤ä¸º 0
            Game.score = parseInt(localStorage.getItem('totalScore')) || 0;
            // ç«‹åˆ»æ›´æ–°å³ä¸Šè§’çš„ UI è®¡åˆ†æ¿
            const scoreBoard = document.getElementById('score-board');
            if(scoreBoard) {
                scoreBoard.innerText = `ğŸ† Score: ${Game.score}`;
            }
            // ============================
            
            renderMenu();
        };

        // --- æ¸¸æˆåŠ¨ç”»ä¸éŸ³æ•ˆæ§åˆ¶ ---
        
        function playAttack(callback) {
            stopCombatTimer();
            // ç­”å¯¹äº†ï¼Œç«‹åˆ»åœæ­¢è®¡æ—¶å’Œæ€ªå…½ç§»åŠ¨
            
            if(Game.sfxShoot) { Game.sfxShoot.currentTime = 0;
            Game.sfxShoot.play().catch(e=>{}); }
            
            const beam = UI.spell;
            // é­”æ³•å­å¼¹å‡†å¤‡
            beam.style.transition = 'none';
            beam.style.left = '80px';
            beam.style.opacity = '1';
            void beam.offsetWidth;
            // å‘å°„ï¼(0.2ç§’é£è¿‡å»)
            beam.style.transition = 'left 0.2s linear, opacity 0.2s';
            beam.classList.add('shooting');
            setTimeout(() => {
                beam.classList.remove('shooting');
                beam.style.opacity = '0';
                
                // å‡»é€€æ€ªå…½ï¼ˆç¬é—´å›åˆ°å³è¾¹ï¼‰
                UI.monster.style.transition = 'none';
                UI.monster.style.right = '15px';
                
        
                if (callback) callback();
            }, 200);
        }

        function playFail() {
            // 1. æ’­æ”¾éŸ³æ•ˆ
            Game.sfxFail.currentTime = 0;
            Game.sfxFail.play().catch(e => console.log("Audio play error", e));

            // 2. å“ˆåˆ©æ‘‡æ™ƒ
            UI.harry.classList.remove('anim-shake');
            void UI.harry.offsetWidth;
            UI.harry.classList.add('anim-shake');
        }


        // --- è¯­éŸ³æ ¸å¿ƒ ---
        function initSpeech() {
            // --- å¾®ä¿¡ä¸“ç”¨ï¼šåŒä¿é™©å‘éŸ³ç³»ç»Ÿ ---

            // å®šä¹‰ä¸€ä¸ªå…¨å±€éŸ³é¢‘å¯¹è±¡ï¼Œç”¨æ¥æ’­æ”¾ MP3
            const onlineAudio = new Audio();
            window.speak = function(text) {
                // 1. åˆ¤æ–­æ˜¯ä¸æ˜¯å¾®ä¿¡æµè§ˆå™¨
                const isWeChat = /MicroMessenger/i.test(navigator.userAgent);
                // 2. å¦‚æœæ˜¯å¾®ä¿¡ï¼Œæˆ–è€…æ–‡æœ¬å¾ˆçŸ­ï¼ˆæ˜¯å•è¯ï¼‰ï¼Œä¼˜å…ˆä½¿ç”¨â€œæœ‰é“è¯å…¸â€çš„åœ¨çº¿ MP3
                // (Type=2 æ˜¯ç¾éŸ³ï¼ŒType=1 æ˜¯è‹±éŸ³)
                if (isWeChat || text.split(' ').length <= 3) {
                    // æ‰“å°æ—¥å¿—æ–¹ä¾¿è°ƒè¯•
                    console.log("æ£€æµ‹åˆ°å¾®ä¿¡æˆ–å•è¯ï¼Œä½¿ç”¨åœ¨çº¿ MP3 æ’­æ”¾: " + text);
                    // åœæ­¢ä¹‹å‰çš„éŸ³é¢‘
                    onlineAudio.pause();
                    onlineAudio.currentTime = 0;

                    // è®¾ç½®åœ¨çº¿å‘éŸ³åœ°å€ (è¿™é‡Œç”¨æœ‰é“è¯å…¸çš„æ¥å£ï¼Œå…è´¹ç¨³å®š)
                    onlineAudio.src = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`;
                    // æ’­æ”¾
                    onlineAudio.play().catch(e => {
                        console.error("MP3 æ’­æ”¾å¤±è´¥ï¼Œå°è¯•å›é€€åˆ°ç³»ç»Ÿè¯­éŸ³", e);
                        // å¦‚æœæ–­ç½‘äº†ï¼ŒMP3 æ’­ä¸å‡ºæ¥ï¼Œå†å°è¯•ç”¨ç³»ç»Ÿè¯­éŸ³å…œåº•
                        systemSpeak(text);
                    });
                } 
                // 3. å¦‚æœä¸æ˜¯å¾®ä¿¡ï¼Œæˆ–è€…æ˜¯é•¿å¥å­ï¼Œç”¨æµè§ˆå™¨çš„ç³»ç»Ÿè¯­éŸ³
                else {
                    systemSpeak(text);
                }
            };

            // åŸæ¥çš„ç³»ç»Ÿè¯­éŸ³å‡½æ•°ï¼Œä½œä¸ºå¤‡ç”¨
            function systemSpeak(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-US';
                    u.rate = 1.0;
                    // å°è¯•è·å–è¯­éŸ³åŒ…
                    const voices = window.speechSynthesis.getVoices();
                    const enVoice = voices.find(v => v.lang.includes('en-US'));
                    if (enVoice) u.voice = enVoice;
            
                    window.speechSynthesis.speak(u);
                }
            }
    
            // --- å‡çº§ç‰ˆï¼šå®æ—¶æµè¯­éŸ³è¯†åˆ«å¼•æ“ ---
            // --- æ¢å¤ä¸ºç¨³å®šç‰ˆï¼šå•æ¬¡è¯­éŸ³è¯†åˆ«å¼•æ“ ---
            if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition ||
                window.webkitSpeechRecognition;
                Game.recognition = new SpeechRecognition();
                Game.recognition.lang = 'en-US'; 
                Game.recognition.continuous = false; 
                Game.recognition.interimResults = false;
                Game.recognition.onstart = () => {
                    Game.isListening = true;
                    UI.btnMic.classList.add('listening'); 
                    UI.micHint.textContent = "æ­£åœ¨æ–½æ³•...";
                };
                
                Game.recognition.onend = () => {
                    Game.isListening = false;
                    UI.btnMic.classList.remove('listening'); 
                    UI.micHint.textContent = "ç‚¹å‡»æ–½æ”¾é­”æ³•";
                };
                
                Game.recognition.onresult = (e) => {
                    verifySpeech(e.results[0][0].transcript);
                };
                
                UI.btnMic.onclick = function() {
                    if(Game.isListening) Game.recognition.stop();
                    else Game.recognition.start();
                };
            } else {
                console.log("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«");
            }
        }
        // --- æ¸¸æˆé€»è¾‘ ---
        function renderMenu() {
            UI.menu.classList.remove('hidden');
            UI.game.classList.add('hidden'); UI.unitList.innerHTML = '';
            const unlocked = parseInt(localStorage.getItem('unlockedUnit') || 1);
            [...new Set(wordList.map(w => w.unit))].sort((a,b)=>a-b).forEach(u => {
                const div = document.createElement('div');
                const isLocked = u > unlocked;
                div.className = `unit-item ${isLocked ? 'locked' : 'active'}`;
                div.textContent = `Unit ${u}`;
                if(!isLocked) div.onclick = () => {
                
                    // 1. æ¿€æ´»æ‰‹æœºè¯­éŸ³å¼•æ“
                    if('speechSynthesis' in window) { 
                        window.speechSynthesis.cancel(); 
                        const w = new SpeechSynthesisUtterance(''); 
                        w.volume = 0; 
        
                        window.speechSynthesis.speak(w); 
                    }
                    
                    // 2. å»æŸ¥è¯¢è¿™ä¸ª Unit çš„ä¸“å±è¿›åº¦
                    const savedProgress = localStorage.getItem('progress_unit_' + u);
            
        
                    if (savedProgress === 'COMPLETED') {
                        // å¦‚æœå·²ç»é€šå…³äº†ï¼Œæç¤ºæ˜¯å¦å¤ä¹ 
                        if (confirm(`Unit ${u} å·²ç»é€šå…³å•¦ï¼ğŸ‰\næ˜¯å¦éœ€è¦æ¸…é™¤è¿›åº¦ï¼Œé‡æ–°å¤ä¹ ä¸€éï¼Ÿ`)) {
                            localStorage.removeItem('progress_unit_' + u);
                            startGame(u, 0); // æ¸…é™¤è®°å½•ï¼Œä»ç¬¬ 0 ç»„é‡æ–°å¼€å§‹
                        }
                    } else if (savedProgress !== null) {
                        // å¦‚æœæœ‰è¿›åº¦è®°å½•ï¼Œç›´æ¥è·³åˆ°å¯¹åº”çš„ç»„
                        const groupIndex = parseInt(savedProgress);
                        startGame(u, groupIndex); 
                    } else {
                        // ç¬¬ä¸€æ¬¡ç©è¿™ä¸ªå•å…ƒï¼Œä»ç¬¬ 0 ç»„å¼€å§‹
                        startGame(u, 0);
                    }
                };
                UI.unitList.appendChild(div);
            });
        }

        function startGame(unitId, startGroupIndex = 0) {
            Game.unit = unitId;
            const raw = wordList.filter(w => w.unit === unitId);
            Game.allGroups = [];
            for(let i=0; i<raw.length; i+=5) Game.allGroups.push(raw.slice(i, i+5));
            // åˆ‡æ¢ç•Œé¢
            UI.menu.classList.add('hidden'); 
            UI.game.classList.remove('hidden');
            // åŠ è½½æŒ‡å®š Group (å¦‚æœæ˜¯æ–°æ¸¸æˆå°±æ˜¯ 0ï¼Œè¯»æ¡£å°±æ˜¯è®°å½•çš„æ•°å­—)
            loadGroup(startGroupIndex);
        }

        function loadGroup(idx) {
            if(idx >= Game.allGroups.length) { 
                startUnitReview();
                return; 
            }
            
            Game.groupIndex = idx;
            Game.currentWords = Game.allGroups[idx];
            
            // --- æ–°å¢ï¼šæ¯åŠ è½½ä¸€ä¸ªæ–°ç»„ï¼Œå°±è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ ---
            autoSave(); 
            
            startPhase(1);
        }

        function startPhase(p) {
            Game.phase = p; Game.wordIndex = 0;
            Game.repCount = 0;
            const pNames = ["Shadowing (è·Ÿè¯»)", "Listening (å¬éŸ³)", "Speaking (è¯´è‹±)", "Spelling (æ‹¼å†™)", "Review"];
            UI.statusPhase.textContent = pNames[p-1] || "Review";
            renderCard();
        }

        function renderCard() {
            const wordObj = Game.currentWords[Game.wordIndex];
            const total = Game.currentWords.length;
            UI.statusProg.textContent = `Word ${Game.wordIndex+1}/${total}`;
            
            UI.areaMic.classList.add('hidden'); UI.areaOpts.classList.add('hidden'); UI.areaSpell.classList.add('hidden');
            UI.areaWord.classList.remove('hidden'); UI.areaMeaning.classList.remove('hidden'); UI.statusRep.classList.add('hidden');
            // å¤ä½æ€ªå…½æ ·å¼
        
            // å¦‚æœä½ æœ‰ä¸åŒæ€ªå…½å›¾ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ ¹æ® index åˆ‡æ¢ src

            if(Game.phase === 1) {
                UI.statusRep.classList.remove('hidden');
                UI.statusRep.textContent = `Hit ${Game.repCount}/3`;
                UI.areaWord.textContent = wordObj.word;
                UI.areaMeaning.textContent = wordObj.meaning;
                UI.areaMic.classList.remove('hidden');
                if(Game.repCount === 0) speak(wordObj.word);
            }
            else if(Game.phase === 2) {
                UI.areaWord.classList.add('hidden');
                UI.areaMeaning.classList.add('hidden');
                UI.areaOpts.classList.remove('hidden');
                speak(wordObj.word);
                generateOptions(wordObj);
            }
            else if(Game.phase === 3 || Game.phase === 5) {
                UI.areaWord.classList.add('hidden');
                UI.areaMeaning.textContent = wordObj.meaning;
                UI.areaMic.classList.remove('hidden');
            }
            else if(Game.phase === 4) {
                UI.areaWord.classList.add('hidden');
                UI.areaMeaning.textContent = wordObj.meaning;
                UI.areaSpell.classList.remove('hidden');
                UI.inputSpell.value = ''; UI.inputSpell.focus();
            }
            startCombatTimer();
            // <--- åŠ ä¸Šè¿™ä¸€è¡Œ
        }

        // --- å‡çº§ç‰ˆï¼šå®æ—¶ç§’æ‰¹éªŒè¯é€»è¾‘ ---
        // --- æ¢å¤ä¸ºç¨³å®šç‰ˆï¼šå•æ¬¡åˆ¤å®šé€»è¾‘ ---
        // --- æ¢å¤ä¸ºç¨³å®šç‰ˆï¼šå•æ¬¡åˆ¤å®šé€»è¾‘ ---
        function verifySpeech(transcript) {
            // é˜²æ­¢æŠ¥é”™
            if (!Game.currentWords || !Game.currentWords[Game.wordIndex]) return;
            const target = Game.currentWords[Game.wordIndex].word;
            // è¿‡æ»¤æ‰æ ‡ç‚¹ç¬¦å·å’Œç©ºæ ¼
            const cleanTrans = transcript.toLowerCase().replace(/[^a-z0-9]/g, '');
            const cleanTarget = target.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            // å¦‚æœå‘éŸ³åŒ¹é…æˆåŠŸ
            if(cleanTrans.includes(cleanTarget) || cleanTarget.includes(cleanTrans)) {
                handleSuccess();
            } else {
                // å¦‚æœå‘éŸ³ä¸åŒ¹é…ï¼Œè§¦å‘å¤±è´¥æ‘‡æ™ƒå’Œæ‰£åˆ†é€»è¾‘
                handleFail();
            }
        }

        function handleSuccess() {
            // ä¿®å¤æŠ¥é”™ 1ï¼šå°†é”™è¯¯çš„ updateScore æ”¹ä¸ºæ­£ç¡®çš„ addScore
            addScore(1);
            playAttack(() => {
                showToast("Magic Hit!", true);
                
                if(Game.phase === 1) {
                    Game.repCount++; 
                    UI.statusRep.textContent = `Hit ${Game.repCount}/3`;
                    
        
                    if(Game.repCount < 3) {
                        startCombatTimer(); // æ¯æ¬¡è¯»å¯¹ï¼Œæ€ªå…½é‡æ–°ä»å³è¾¹è¿‡æ¥
                        // ä¿®å¤æŠ¥é”™ 2ï¼šå°†é”™è¯¯çš„ manualSpeak æ”¹å›æ­£å¸¸çš„ speak å‘éŸ³
                        speak(Game.currentWords[Game.wordIndex].word);
                    } else 
                    { 
                        Game.repCount = 0; 
                        nextWord(); 
                    }
                } else {
                    nextWord();
            
                }
            });
        }

        function handleFail() {
            playFail();
            showToast("Miss!", false);
        }

        function nextWord() {
            Game.wordIndex++;
            if(Game.wordIndex >= Game.currentWords.length) {
                if(Game.phase < 4) startPhase(Game.phase + 1);
                else if (Game.phase === 4) { 
                    showToast("Group Cleared!", true);
                    // === æ–°å¢ï¼šå°ç»„é€šå…³ï¼Œå¥–åŠ± 10 åˆ†ï¼===
                    addScore(10);
                    // ===============================

                    setTimeout(() => loadGroup(Game.groupIndex + 1), 1000);
                }
                else finishUnit();
            } else renderCard();
        }

        function generateOptions(correctObj) {
            UI.areaOpts.innerHTML = '';
            const others = wordList.filter(w => w.word !== correctObj.word);
            const distractors = others.sort(() => 0.5 - Math.random()).slice(0, 3);
            const opts = [...distractors, correctObj].sort(() => 0.5 - Math.random());

            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt.meaning;
                btn.onclick = () => {
                    if(opt.word === correctObj.word) handleSuccess();
            
                    else { handleFail(); speak(correctObj.word); }
                };
                UI.areaOpts.appendChild(btn);
            });
            const replay = document.createElement('button');
            replay.className = 'option-btn'; replay.style.textAlign='center'; replay.textContent='ğŸ”Š é‡å¬';
            replay.onclick = () => speak(correctObj.word);
            UI.areaOpts.appendChild(replay);
        }

        function checkSpelling() {
            const input = UI.inputSpell.value.trim().toLowerCase();
            const target = Game.currentWords[Game.wordIndex].word.toLowerCase();
            if(input === target) {
                UI.inputSpell.classList.add('correct');
                handleSuccess();
                setTimeout(() => UI.inputSpell.classList.remove('correct'), 500);
            } else {
                UI.inputSpell.classList.add('wrong');
                handleFail();
            }
        }

        function startUnitReview() {
            Game.phase = 5;
            UI.statusPhase.textContent = "Boss Battle (Review)";
            Game.currentWords = wordList.filter(w => w.unit === Game.unit).sort(() => 0.5 - Math.random());
            Game.wordIndex = 0; renderCard();
        }

        function finishUnit() {
            showToast("Unit Victory!", true);
            const currentUnlocked = parseInt(localStorage.getItem('unlockedUnit') || 1);
            
            if(Game.unit >= currentUnlocked) {
                localStorage.setItem('unlockedUnit', Game.unit + 1);
            }
            
            // --- ä¿®æ”¹ï¼šç»™å½“å‰å•å…ƒæ‰“ä¸Šâ€œå½»åº•é€šå…³â€çš„æ ‡è®° ---
            localStorage.setItem('progress_unit_' + Game.unit, 'COMPLETED');
            setTimeout(() => { UI.game.classList.add('hidden'); renderMenu(); }, 2000);
        }

        function showToast(msg, isSuccess) {
            UI.feedback.textContent = msg;
            UI.feedback.className = `feedback-toast show ${isSuccess ? 'success' : 'error'}`;
            setTimeout(() => UI.feedback.className = 'feedback-toast', 1000);
        }
        function exitToMenu() { UI.game.classList.add('hidden'); renderMenu(); }
        function resetProgress() { if(confirm("é‡ç½®è¿›åº¦ï¼Ÿ")) { localStorage.clear(); renderMenu();
        } }
        UI.inputSpell.addEventListener('keyup', (e) => { if(e.key === 'Enter') checkSpelling(); });
        // æ‰‹åŠ¨æ’­æ”¾å½“å‰å•è¯
        function speakCurrentWord() {
            if (Game.currentWords && Game.currentWords[Game.wordIndex]) {
                speak(Game.currentWords[Game.wordIndex].word);
            }
        }
    </script>
    <div id="save-toast" class="save-toast">ğŸ’¾ è¿›åº¦å·²ä¿å­˜</div>
</body>
</html>